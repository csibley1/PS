ipmo activedirectory
$creds = get-credential

$dstusr = read-host 'User to set up (firstname lastname)'
$srcusr = read-host 'User to copy (firstname lastname)'

$usrprops = get-aduser -filter {((displayname -eq $srcusr) -or (samaccountname -eq $srcusr)) -and (samaccountname -notlike '*0')} -properties *
$newOU = ($usrprops.DistinguishedName -split ",",2)[1]

#Generate a username that is 10 characters or less
try {
    #Check for extended names like 'Firstname Von Lastname'
    $newuname = (($dstusr.substring(0,1)+(($dstusr -split " ",3)[1]).substring(0,1))+(($dstusr -split " ",3)[2]).substring(0, [System.Math]::Min(8, (($dstusr -split " ",3)[2]).length))).replace("'","")
    }
    catch {
        #Going with 'Firstname Lastname'
        $newuname = (($dstusr.substring(0,1)+(($dstusr -split " ",2)[1]).substring(0, [System.Math]::Min(9, (($dstusr -split " ",2)[1]).length)))).replace("'","")
        }
    finally {
    #Complete setup
    $name = $dstusr
    $firstname = ($dstusr -split " ",2)[0]
    $lastname = ($dstusr -split " ",2)[1]
    $title = read-host 'Job title'
    $dept = $usrprops.Department
    $bldg = $usrprops.Office
    $bu = $usrprops.Company
    $upn = $newuname+'@CONTOSO.com'
    $country = $usrprops.Country
    $ext1 = $usrprops.extensionAttribute1
    $street = $usrprops.StreetAddress
    $city = $usrprops.City
    $state = $usrprops.State
    $zip = $usrprops.PostalCode
    $homedir = '\\FILESRV\userhome$\'+$newuname
    # Standard procedure is to change the password immediately after logging in for first-time setup
    $pw = ConvertTo-SecureString -String "r3@lLy$EcuRe!!!1!1!11!!1" -AsPlainText -Force
    $checkuser = get-aduser -filter "samaccountname -eq '$newuname'"

#Create the account in AD
if ($checkuser -ne $null){
    write-host 'user exists'
    }else{
    New-ADUser -credential $creds `
        -Name $name `
        -GivenName $firstname `
        -Surname $lastname `
        -DisplayName $name `
        -Samaccountname $newuname `
        -Userprincipalname $upn `
        -Description "$title" `
        -Title "$title" `
        -Company $bu `
        -Department $dept `
        -Office $bldg `
        -StreetAddress $street `
        -City $city `
        -State $state `
        -Country $country `
        -PostalCode $zip `
        -Path $newOU `
        -HomeDirectory $homedir `
        -HomeDrive 'H:' `
        -ScriptPath 'logon.vbs' `
        -AccountPassword($pw) `
        -Enabled $true

#Add extensionattributes for dynamic DLs
Set-ADUser -Credential $creds -identity $newuname -add @{extensionattribute1 = "$ext1"}
Set-ADUser -Credential $creds -identity $newuname -add @{extensionattribute2 = "$bldg"}

#Copy groups
$groups = Get-ADPrincipalGroupMembership -identity $usrprops.SamAccountName
foreach ($group in $groups){
    write-host 'Adding'$dstusr 'to'$group.name
    Add-ADGroupMember -credential $creds -identity $group -Members $newuname
    }

#If Contractor, add ext3
    if ($newOU -like "OU=Contractor,DC=CONTOSO,DC=com"){
        Set-ADUser -Credential $creds -identity $newuname -add @{extensionattribute3 = "Contractor"}
        }
    }
}
